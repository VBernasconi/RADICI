<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mapbox Similarity Search with Date & Category Filters</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

    <!-- Mapbox CSS & JS -->
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" 
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Xanh+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@200;400;600&family=Xanh+Mono&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />

    <script src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha384-GNFwBvfVxBkLMJpYMOABq3c+d3KnQxudP/mGPkzpZSTYykLBNsZEnG2D9G/X/+7D" crossorigin="anonymous" async></script>
</head>
<body>
    <div class="container">
        <div class="row">
            <div id="sidebar_metamotor">
                <span id="close_metamotor" class="pointer">Torna indietro ></span>
                <div id="featured-item"></div>
                <div id="similar-items"></div>
                <!--<div id="results"></div>-->
            </div>
            <button type="button" id="btn-toggle" class="btn">Grid</button>
            <div class="row filtri">
                <img class="logo" src="img/Logo-Header.svg"/>
                <p class="d-inline-flex gap-1">
                    <button class="btn btn-filtri" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltri" aria-expanded="false" aria-controls="collapseFiltri">
                    Filtri
                    <span class="arrow">&or;</span>
                    </button>
                </p>
                <div class="row">
                    <div class="collapse" id="collapseFiltri">
                        <div class="card card-body">
                            <div class="row">
                                <input type="text" id="search-box" placeholder="Search by keyword..." />
                            </div>
                            <div class="row filters-row">
                                <div class="col selected_type">
                                    <div class="row">
                                        <h3>Ambiti Creativi</h3>
                                        <div id="type-filter"></div>
                                    </div>
                                </div>
                                <div class="col selected_date">
                                    <h3>Periodo Storico</h3>
                                    <div id="date-filter">
                                        <button class="filter-button" data-start="1192" data-end="2024" data-filter-type="date" data-filter-value="all">All</button>
                                    </div>
                                </div>
                                <div class="col selected_fondo">
                                    <h3>Fondo Archivistico</h3>
                                    <div id="fondo-filter">
                                        <button class="filter-button" data-filter-type="fondo" data-filter-value="all">All</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <button class="btn btn-filter-close" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltri" aria-expanded="false" aria-controls="collapseFiltri">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mainContent">
                <div id="grid" class="">
                    <div class="row">
                        <div class="col" id="col-1">
                        </div>
                        <div class="col" id="col-2">
                        </div>
                        <div class="col" id="col-3">
                        </div>
                        <div class="col" id="col-4">
                        </div>
                    </div>
                </div>
                
                <div id="map" class="active">
                    <div id="main-content">
                        <!--<div id="map"></div>-->
                        <ul id="search-results"></ul>
                    </div>
                </div>
            </div>
        </div>  
    </div>
    <!-- jQuery must come first -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
   <script>
        const serverURL = 'http://137.204.195.17:5030';
        const toggleButton = document.getElementById('btn-toggle');
        const mapContainer = document.getElementById('map');
        const gridContainer = document.getElementById('grid');
        const types = ['design', 'architecture', 'audiovisual', 'mode', 'photography', 'music', 'publishing', 'dance'] //['publishing', 'music', 'architecture', 'audiovisual', 'photography', 'design']

        const closeSidebarBtn = document.getElementById('close_metamotor');

        const activeFilters = {
            date: null,
            type: null,
            fondo: null
        };

        let geojson = null;

        fetch('redis_export.geojson') //'objects_and_coordinates_29_09_2025.geojson')
            .then(response => response.json())
            .then(data => {

                geojson = data;

                const fondosSet = new Set();
                const years = [];

                geojson.features.forEach(feature => {
                    const fondo = feature.properties.fondo;
                    const date = feature.properties.date;

                    if (fondo) {
                        fondosSet.add(fondo);
                    }
                    if (typeof date === 'number') {
                        years.push(date);
                    } else if (typeof date === 'string') {
                        const parsedYear = parseInt(date, 10);
                        if (!isNaN(parsedYear)) {
                            years.push(parsedYear);
                        }
                    }  
                });

                const fondos = Array.from(fondosSet).sort();

                // Generate fondo filters
                const fondoContainer = document.getElementById('fondo-filter');
                fondos.forEach(fondo => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-button';
                    btn.textContent = fondo;
                    btn.dataset.filterType = 'fondo';
                    btn.dataset.filterValue = fondo;
                    btn.onclick = function() {
                        //btn.classList.toggle('selected');
                        // Update only the selected category
                        activeFilters[btn.dataset.filterType] = btn.dataset.filterValue;

                        // Update button UI: mark only this button as selected in its category
                        updateButtonSelections(btn.dataset.filterType, btn.dataset.filterValue);

                        // Apply filters
                        filterFeatures();
                    };
                    fondoContainer.appendChild(btn);
                });

                if (years.length > 0) {
                    const earliestYear = Math.min(...years);
                    const latestYear = Math.max(...years);

                    const container = document.getElementById('date-filter');
                    const interval = 20;//50;
                    //for (let start = earliestYear; start <= latestYear; start += interval) {
                    for (let start = 1900; start <= 2020; start += interval){
                        const end = Math.min(start + interval - 1, latestYear);
                        const button = document.createElement('button');
                        button.className = 'filter-button';
                        button.textContent = `${start} - ${end}`;
                        button.dataset.start = start;
                        button.dataset.end = end;
                        button.dataset.filterType = 'date';
                        button.dataset.filterValue = JSON.stringify({ start: start, end: end });
                        // Add event listener if needed
                        button.onclick = function() {
                            //button.classList.toggle('selected');
                            //applyFilter(this);
                            //updateFiltersFromButtons();
                            activeFilters[button.dataset.filterType] = button.dataset.filterValue;
                            // Update button UI: mark only this button as selected in its category
                            updateButtonSelections(button.dataset.filterType, button.dataset.filterValue);
                            // Apply filters
                            filterFeatures();
                            //applyAllFilters();
                        };
                        container.appendChild(button);
                    }
                } else {
                    console.log('No year data found.');
                }


            });
        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.dataset.filterType; // e.g., 'date'
                const filterValue = btn.dataset.filterValue; // e.g., 'ALL' or specific value

                if (filterValue === 'all') {
                    // Reset the filter for this category
                    activeFilters[filterType] = null;
                } else {
                    // Set the selected filter
                    activeFilters[filterType] = filterValue;
                }
                // Update button UI
                updateButtonSelections(filterType, filterValue);

                // Apply filters
                filterFeatures();
            });
        });

        function filterFeatures() {
            let filteredFeatures = geojson.features;

            // Filter by date if selected
            if (activeFilters.date) {
                let filterValue = JSON.parse(activeFilters.date);
                filteredFeatures = filteredFeatures.filter(f => {
                    const featureDate = f.properties.date; // your date property
                    const dateRangeStr = f.properties.date;
                    const dateRange = parseDateRange(dateRangeStr);
                    if (!dateRange) return false;
                    return (
                        dateRange.start >= filterValue.start &&
                        dateRange.end <= filterValue.end
                    );
                });
            }

            // Filter by type if selected
            if (activeFilters.type) {
                filteredFeatures = filteredFeatures.filter(f => f.properties.type === activeFilters.type);
            }
            // Filter by fondo if selected
            if (activeFilters.fondo) {
                filteredFeatures = filteredFeatures.filter(f => f.properties.fondo === activeFilters.fondo);
            }

            // Update map display
            displayFeatures(filteredFeatures);
            console.log(activeFilters.type, activeFilters.fondo, activeFilters.date);
            updateMapFilters(filteredFeatures, activeFilters.type === 'all' ? null : activeFilters.type, activeFilters.fondo, activeFilters.date);
            //updateMapFilters(activeFilters.type === 'all' ? null : activeFilters.type, activeFilters.fondo, activeFilters.date);
            //applyAllFilters();
        }

        function updateButtonSelections(filterType, selectedValue) {
            // Deselect all buttons in the same category
            document.querySelectorAll(`.filter-button[data-filter-type="${filterType}"]`).forEach(btn => {
                if (btn.dataset.filterValue === selectedValue) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }
                
        toggleButton.addEventListener('click', () => {
            if (mapContainer.classList.contains('active')) {
                // Switch to grid
                toggleButton.textContent = "Map"; // Update button label
                mapContainer.classList.remove('active');
                gridContainer.classList.add('active');
            } else {
                // Switch to map
                toggleButton.textContent = "Grid"; // Update button label
                gridContainer.classList.remove('active');
                mapContainer.classList.add('active');
            }
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.style.right = '-800px';
            document.querySelector('.mainContent').classList.remove('blur-background');
        })

        function getObjectById(id) {
            // Assuming geojsonData.features is an array of features
            const feature = geojson.features.find(f => String(f.properties.id) === String(id));
            //const feature = geojson.features.find(f => f.id === id);
            console.log("DID IT FIND FEATURES?",feature.properties);
            return feature.properties|| null; // returns null if not found
        }

        function displayResults(results) {
            console.log(results);
            const resultsDiv = document.getElementById('similar-items');
            const featuredDiv = document.getElementById('featured-item');

            // Clear previous content
            featuredDiv.innerHTML = '';
            resultsDiv.innerHTML = '';

            if (!results || results.length === 0) {
                resultsDiv.textContent = 'No similar objects found.';
                return;
            }

            // Featured item
            const [first, ...similarItems] = results;
            const firstImgFile = first.img_path.split('/').pop();
            const firstOrigin = (first.origin || '').split('/');
            console.log(first)

            featuredDiv.innerHTML = `
                <div class="image-container">
                    <img src="${serverURL}/images/${firstImgFile}" alt="${first.title || first.id}" class="featured-image" />
                </div>
                <div class="featured-info">
                    <div class="sidebar-title">
                        <h3>${first.title || ''}</h3>
                        <p>${first.model_base || first.description || ''}</p>
                    </div>
                    <table class="sidebar-info">
                        <tbody>
                            <tr><td>Autore:</td><td>${first.author || '-'}</td></tr>
                            <tr><td>Data:</td><td>${first.date || '-'}</td></tr>
                            <tr><td>Archivio:</td><td><a href="${setupURL(first.archive, first.id)}" target="_blank">${first.fondo|| '-'}</a></td></tr>
                            <tr><td>Ente:</td><td><a href="${setupURL(first.archive, first.id)}" target="_blank">${first.archive || firstOrigin[1] ||  '-'}</a></td></tr>
                            <tr><td>Collocazione:</td><td>${firstOrigin[1] || first.place || '-'}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

            // Similar items (max 3)
            resultsDiv.innerHTML = similarItems.slice(0, 3)
                .map(item => {
                    if(item.img_path){
                        const imgFile = item.img_path.split('/').pop();
                        return `
                            <div class="similar-item" data-id="${item.id}">
                                <img src="${serverURL}/images/${imgFile}" alt="${item.title || item.id}" class="similar-image"/>
                            </div>
                        `;
                    }
                }).join('');

            // Add click listeners for similar items
            document.querySelectorAll('#similar-items .similar-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.getAttribute('data-id');
                    object = getObjectById(id);
                    searchSimilarObjects(id);
                    const matchedFeature = geojson.features.find(f => String(f.properties.id) === String(id));
                    if (matchedFeature) {
                        const coords = matchedFeature.geometry.coordinates;
                        map.flyTo({
                            center: coords,
                            zoom: 50
                        });
                        map.once('moveend', () => {
                            displayPopup(matchedFeature, map);
                        });
                    }
                });
            });
        }
    </script>
    <script src="map.js"></script>
    <script src="grid.js"></script>
</body>
</html>
