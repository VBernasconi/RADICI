{% extends "base.html" %}
{% block content %}
    <div class="container">
        <div class="row">
            <div id="sidebar_metamotor">
                <span id="close_metamotor" class="pointer">Torna indietro ></span>
                <div id="featured-item"></div>
                <div id="similar-items"></div>
                <div id="samecollection-items"></div>
                <!--<div id="results"></div>-->
            </div>
            <button type="button" id="btn-toggle" class="btn">Grid</button>
            <div class="row filtri">
                <!--<img src="{{ url_for('static', filename='img/Logo-Header.svg') }}">-->
                <p class="d-inline-flex gap-1">
                    <button class="btn btn-filtri" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltri" aria-expanded="false" aria-controls="collapseFiltri">
                    Filtri
                    <span class="arrow">&or;</span>
                    </button>
                </p>
                <div class="row">
                    <div class="collapse" id="collapseFiltri">
                        <div class="card card-body">
                            <div class="row">
                                <input type="text" id="search-box" placeholder="Search by keyword..." />
                            </div>
                            <div class="row filters-row">
                                <div class="col selected_type">
                                    <div class="row">
                                        <h3>Ambiti Creativi</h3>
                                        <div id="type-filter"></div>
                                    </div>
                                </div>
                                <div class="col selected_date">
                                    <h3>Periodo Storico</h3>
                                    <div id="date-filter">
                                        <button class="filter-button" data-start="1192" data-end="2024" data-filter-type="date" data-filter-value="all">All</button>
                                    </div>
                                </div>
                                <div class="col selected_fondo">
                                    <h3>Fondo Archivistico</h3>
                                    <div id="fondo-filter">
                                        <button class="filter-button" data-filter-type="fondo" data-filter-value="all">All</button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <button class="btn btn-filter-close" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFiltri" aria-expanded="false" aria-controls="collapseFiltri" id="close-filters">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mainContent">
                <div id="grid" class="">
                    <div class="row">
                        <div class="col" id="col-1">
                        </div>
                        <div class="col" id="col-2">
                        </div>
                        <div class="col" id="col-3">
                        </div>
                        <div class="col" id="col-4">
                        </div>
                    </div>
                    <div id="loading-spinner" class="spinner hidden"></div>
                </div>
                <div id="favoriteModal" class="modal hidden">

                    <div class="modal-content">
                        <span class="close-icon" onclick="closeFavoriteModal()">&times;</span>
                
                        <!-- LOGIN REQUIRED SECTION -->
                        <div id="login-section" class="section hidden">
                            <h3>ARTIFEX</h3>
                            <p>Ciao! Per poter salvare i contenuti è necessario autenticarsi</p>
                            <img src="{{ url_for('static', filename='img/icons-png/architecture-icon.png') }}">

                            <input id="login-username" type="text" placeholder="Username" class="input-field">
                            <input id="login-password" type="password" placeholder="Password" class="input-field">
                
                            <button class="modal-btn" onclick="loginUser()">Accedi</button>
                        </div>
                
                        <!-- USER LOGGED IN SECTION -->
                        <div id="collection-section" class="section hidden">
                            <h4>Aggiungi ai preferiti</h4>
                            <input id="new-collection-name" class="input-field" placeholder="Crea nuova raccolta">
                            <button class="modal-btn" onclick="createCollection()">Crea raccolta</button>
                            <p>Oppure scegli una collezione</p>
                            <select id="collection-select" class="input-field"></select>
                            <button class="modal-btn primary" onclick="saveObjectToCollection()">Salva</button>
                        </div>

                        <!-- USER LOGGED IN SECTION -->
                        <div id="success-section" class="section hidden">
                            <h4>L'oggetto è stato salvato!</h4>
                            <button class="modal-btn primary" href="#"></button>
                        </div>
                
                    </div>
                
                </div>
                
                
                <div id="map" class="active">
                    <div id="main-content">
                        <!--<div id="map"></div>-->
                        <ul id="search-results"></ul>
                    </div>
                </div>
            </div>
        </div>  
    </div>
    <!-- jQuery must come first -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script>
        const serverURL = 'http://192.168.249.170:5030';//'http://192.168.249.170:5030';//'http://127.0.0.1:5030'; //'http://137.204.195.17:5030';
        
        const toggleButton = document.getElementById('btn-toggle');
        const mapContainer = document.getElementById('map');
        const gridContainer = document.getElementById('grid');
        const types = ['design', 'architecture', 'audiovisual', 'mode', 'photography', 'music', 'publishing', 'dance'] //['publishing', 'music', 'architecture', 'audiovisual', 'photography', 'design']

        const closeSidebarBtn = document.getElementById('close_metamotor');
        const sidebar = document.getElementById('sidebar_metamotor');


        let allFeatures = [];     // Store all loaded features
        let currentOffset = 0;    // Track current number of loaded items
        const itemsPerPage = 20;  // Load 20 items at a time

        const activeFilters = {
            date: null,
            type: null,
            fondo: null
        };

        let geojson = null;

        const closeFiltersBtn = document.getElementById('close-filters');
        const filtersCollapse = document.getElementById('collapseFiltri');

        if (closeFiltersBtn && filtersCollapse) {
            closeFiltersBtn.addEventListener('click', () => {
                const bsCollapse = bootstrap.Collapse.getOrCreateInstance(filtersCollapse);
                bsCollapse.hide();
            });
        }
        closeSidebarBtn.addEventListener('click', () => {
            sidebar.style.right = '-800px';
            document.querySelector('.mainContent').classList.remove('blur-background');

            const url = new URL(window.location);
            url.searchParams.delete("object");
            window.history.pushState({}, "", url);
        });

        function buildUsedDateIntervals(years, interval = 20) {
            const usedBins = new Set();

            years.forEach(year => {
                const binStart = Math.floor(year / interval) * interval;
                const boundedStart = Math.max(binStart, 1900);
                const boundedEnd = boundedStart + interval - 1;
                usedBins.add(JSON.stringify({ start: boundedStart, end: boundedEnd }));
            });

            return Array.from(usedBins)
                .map(s => JSON.parse(s))
                .sort((a, b) => a.start - b.start);
        }


        fetch(GEOJSON_URL)//fetch('redis_export.geojson') //'objects_and_coordinates_29_09_2025.geojson')
            .then(response => response.json())
            .then(data => {

                geojson = data;

                const fondosSet = new Set();
                const years = [];

                geojson.features.forEach(feature => {
                    const fondo = feature.properties.fondo;
                    const date = feature.properties.date;

                    if (fondo) {
                        fondosSet.add(fondo);
                    }
                    if (typeof date === 'number') {
                        years.push(date);
                    } else if (typeof date === 'string') {
                        const parsedYear = parseInt(date, 10);
                        if (!isNaN(parsedYear)) {
                            years.push(parsedYear);
                        }
                    }  
                });

                const fondos = Array.from(fondosSet).sort();

                // Generate fondo filters
                const fondoContainer = document.getElementById('fondo-filter');
                fondos.forEach(fondo => {
                    const btn = document.createElement('button');
                    btn.className = 'filter-button';
                    btn.textContent = fondo;
                    btn.dataset.filterType = 'fondo';
                    btn.dataset.filterValue = fondo;
                    btn.onclick = function() {
                        //btn.classList.toggle('selected');
                        // Update only the selected category
                        activeFilters[btn.dataset.filterType] = btn.dataset.filterValue;

                        // Update button UI: mark only this button as selected in its category
                        updateButtonSelections(btn.dataset.filterType, btn.dataset.filterValue);

                        // Apply filters
                        filterFeatures();
                    };
                    fondoContainer.appendChild(btn);
                });

                if (years.length > 0) {

                    const container = document.getElementById('date-filter');
                    const interval = 20;

                    // Build only bins that appear in data
                    const bins = buildUsedDateIntervals(years, interval);

                    bins.forEach(bin => {
                        const { start, end } = bin;
                        const button = document.createElement("button");

                        button.className = "filter-button";
                        button.textContent = `${start} - ${end}`;
                        button.dataset.start = start;
                        button.dataset.end = end;
                        button.dataset.filterType = "date";
                        button.dataset.filterValue = JSON.stringify(bin);

                        button.onclick = function() {
                            activeFilters.date = button.dataset.filterValue;
                            updateButtonSelections("date", button.dataset.filterValue);
                            filterFeatures();
                        };

                        container.appendChild(button);
                    });
                } else {
                    console.log('No year data found.');
                }
                initMap(data);
            });
        document.querySelectorAll('.filter-button').forEach(btn => {
            btn.addEventListener('click', () => {
                const filterType = btn.dataset.filterType; // e.g., 'date'
                const filterValue = btn.dataset.filterValue; // e.g., 'ALL' or specific value

                if (filterValue === 'all') {
                    // Reset the filter for this category
                    activeFilters[filterType] = null;
                } else {
                    // Set the selected filter
                    activeFilters[filterType] = filterValue;
                }
                // Update button UI
                updateButtonSelections(filterType, filterValue);

                // Apply filters
                filterFeatures();
            });
        });

        function filterFeatures() {

            let filtered = geojson.features;

            // --- Apply DATE ---
            if (activeFilters.date) {
                const range = JSON.parse(activeFilters.date);
                filtered = filtered.filter(f => {
                    const dr = parseDateRange(f.properties.date);
                    return dr && dr.start >= range.start && dr.end <= range.end;
                });
            }

            // --- Apply TYPE ---
            if (activeFilters.type) {
                filtered = filtered.filter(f => f.properties.type === activeFilters.type);
            }

            // --- Apply FONDO ---
            if (activeFilters.fondo) {
                filtered = filtered.filter(f => f.properties.fondo === activeFilters.fondo);
            }

            // ---- HERE IS THE MAGIC: UPDATE OTHER FILTERS ----
            const remaining = computeRemainingFilterOptions(filtered);
            updateFilterButtonsAvailability(remaining);

            // ---- Update your grid/map results ----
            clearFeatureColumns();
            allFeatures = filtered;
            loadMoreFeatures();
            //updateMapFilters(filtered, activeFilters.type, activeFilters.fondo, activeFilters.date);
            applyAllFilters();
        }


        function updateURLWithObject(id) {
            const url = new URL(window.location);
            url.searchParams.set("object", id);
            window.history.pushState({}, "", url);
        }

        function updateButtonSelections(filterType, selectedValue) {
            // Deselect all buttons in the same category
            document.querySelectorAll(`.filter-button[data-filter-type="${filterType}"]`).forEach(btn => {
                if (btn.dataset.filterValue === selectedValue) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
        }
        function getDateIntervalForYear(year) {
            const interval = 20;        // Same interval you used to create buttons
            const start = Math.floor(year / interval) * interval;
            let mappedStart = Math.max(start, 1900);  // Minimum bound used in your UI
            let mappedEnd = mappedStart + interval - 1;
            return JSON.stringify({ start: mappedStart, end: mappedEnd });
        }

        toggleButton.addEventListener('click', () => {
            if (mapContainer.classList.contains('active')) {
                // Switch to grid
                toggleButton.textContent = "Map"; // Update button label
                mapContainer.classList.remove('active');
                gridContainer.classList.add('active');
            } else {
                // Switch to map
                toggleButton.textContent = "Grid"; // Update button label
                gridContainer.classList.remove('active');
                mapContainer.classList.add('active');
            }
        });

        function getObjectById(id) {
            // Assuming geojsonData.features is an array of features
            const feature = geojson.features.find(f => String(f.properties.id) === String(id));
            //const feature = geojson.features.find(f => f.id === id);
            console.log("DID IT FIND FEATURES?",feature.properties);
            return feature.properties|| null; // returns null if not found
        }

        function displayResults(results) {
            console.log(results);
            const resultsDiv = document.getElementById('similar-items');
            const featuredDiv = document.getElementById('featured-item');
            const samecollectionDiv = document.getElementById('samecollection-items');

            // Clear previous content
            featuredDiv.innerHTML = '';
            resultsDiv.innerHTML = '';
            samecollectionDiv.innerHTML = '';


            if (!results || results.length === 0) {
                resultsDiv.textContent = 'No similar objects found.';
                return;
            }

            // Featured item
            const [first, ...similarItems] = results;
            const firstImgFile = first.img_path.split('/').pop();
            const firstOrigin = (first.origin || '').split('/');
            console.log(first)

            // Here I update the URL based on the id of the object
            updateURLWithObject(first.id);

            featuredDiv.innerHTML = `
                <div class="image-container image-container-color">
                    <img src="${serverURL}/images/${firstImgFile}" alt="${first.title || first.id}" class="featured-image" />
                </div>
                <div class="featured-info">
                    <div class="sidebar-title">
                        <h3>${first.title || ''}</h3>
                        <p>${first.model_base || first.description || ''}</p>
                    </div>
                    <table class="sidebar-info">
                        <tbody>
                            <tr><td>Autore:</td><td>${first.author || '-'}</td></tr>
                            <tr><td>Data:</td><td>${first.date || '-'}</td></tr>
                            <tr><td>Archivio:</td><td>
                                <a href="${setupURL(first.archive, first.id)}" target="_blank">
                                    ${first.fondo ?? (first.archive === 'benedetti' ? 'Corago' : '-')}
                                </a>
                            </td></tr>
                            <tr><td>Ente:</td><td><a href="${setupURL(first.archive, first.id)}" target="_blank">${first.archive || firstOrigin[1] ||  '-'}</a></td></tr>
                            <tr><td>Collocazione:</td><td>${firstOrigin[1] || first.place || '-'}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;

            const currentFondo = first.fondo;

            const sameCollectionItems = geojson.features
                .filter(f => f.properties.fondo === currentFondo && f.properties.id !== first.id)
                .slice(0, 3); // limit to 3

            console.log("Collection items!");
            console.log(sameCollectionItems);

            if (sameCollectionItems.length > 0) {
                samecollectionDiv.innerHTML = `<div class="similar-res-title">Appartenenti allo stesso archivio</div><div class="similar-items-wrapper">` +
                    sameCollectionItems.map(item => {
                        const props = item.properties;
                        if (props.img_path) {
                            const imgFile = props.img_path.split('/').pop();
                            return `
                                <div class="similar-item image-container-color" data-id="${props.id}">
                                    <img src="${serverURL}/images/${imgFile}" alt="${props.title || props.id}" class="similar-image"/>
                                </div>
                            `;
                        }
                    }).join('') +
                    `</div>`
                ;
            }

            // Add click listeners for similar items
            document.querySelectorAll('#samecollection-items .similar-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.getAttribute('data-id');
                    object = getObjectById(id);
                    searchSimilarObjects(id);
                    const matchedFeature = geojson.features.find(f => String(f.properties.id) === String(id));
                    if (matchedFeature) {
                        const coords = matchedFeature.geometry.coordinates;
                        map.flyTo({
                            center: coords,
                            zoom: 50
                        });
                        map.once('moveend', () => {
                            displayPopup(matchedFeature, map);
                        });
                    }
                });
            });

            // Similar items (max 3)
            resultsDiv.innerHTML = `<div class="similar-res-title">Risultati simili</div><div class="similar-items-wrapper">` + similarItems.slice(0, 3)
                .map(item => {
                    if(item.img_path){
                        const imgFile = item.img_path.split('/').pop();
                        return `
                            <div class="similar-item image-container-color" data-id="${item.id}">
                                <img src="${serverURL}/images/${imgFile}" alt="${item.title || item.id}" class="similar-image"/>
                            </div>
                        `;
                    }
                }).join('') + `</div>`;

            // Add click listeners for similar items
            document.querySelectorAll('#similar-items .similar-item').forEach(el => {
                el.addEventListener('click', () => {
                    const id = el.getAttribute('data-id');
                    object = getObjectById(id);
                    searchSimilarObjects(id);
                    const matchedFeature = geojson.features.find(f => String(f.properties.id) === String(id));
                    if (matchedFeature) {
                        const coords = matchedFeature.geometry.coordinates;
                        map.flyTo({
                            center: coords,
                            zoom: 50
                        });
                        map.once('moveend', () => {
                            displayPopup(matchedFeature, map);
                        });
                    }
                });
            });
        }
        async function keywordSearch(input) {
            try {
                const response = await fetch(`${serverURL}/search_keywords?q=${encodeURIComponent(input)}`);
                const data = await response.json();

                console.log("Keyword search response:", data);

                const results = data.results || [];
                const matchedIDs = results.map(item => item.id);

                // Match Redis results to local geojson features
                const matchedFeatures = geojson.features.filter(feature =>
                    matchedIDs.includes(feature.properties.id)
                );

                if (mapContainer.classList.contains('active')) {
                    // Display sidebar in map mode
                    const sidebar = document.getElementById('sidebar_metamotor');
                    sidebar.style.right = '0';
                    displayResults(results);
                } else {
                    // Display in grid mode
                    clearFeatureColumns();
                    allFeatures = matchedFeatures;
                    currentOffset = 0;
                    loadMoreFeatures();
                }

            } catch (err) {
                console.error('Search API error:', err);
            }
        }
        document.getElementById("search-box").addEventListener("keyup", (e) => {
            if (e.key === "Enter") {
                const input = e.target.value.trim();
                if (input.length > 0) {
                    keywordSearch(input);
                }
            }
        });

        // --- AUTO-OPEN OBJECT IF URL HAS ?object=ID ---
        window.addEventListener("load", () => {
            const url = new URL(window.location);
            const objectId = url.searchParams.get("object");

            if (objectId) {
                const feature = geojson.features.find(f => String(f.properties.id) === objectId);
                if (feature) {
                    // Open sidebar
                    document.getElementById("sidebar_metamotor").style.right = "0";

                    // Load object + similar items
                    searchSimilarObjects(objectId);

                    // Center map & show popup
                    const coords = feature.geometry.coordinates;
                    map.once("load", () => {
                        map.flyTo({ center: coords, zoom: 50 });
                        map.once("moveend", () => {
                            displayPopup(feature, map);
                        });
                    });
                }
            }
        });
    
        function computeRemainingFilterOptions(features) {
            const remaining = {
                fondos: new Set(),
                types: new Set(),
                dates: new Set()
            };

            features.forEach(f => {
                if (f.properties.fondo) remaining.fondos.add(f.properties.fondo);
                if (f.properties.type) remaining.types.add(f.properties.type);

                //const dr = parseDateRange(f.properties.date);
                //if (dr) remaining.dates.add(JSON.stringify({start: dr.start, end: dr.end}));
                const dr = parseDateRange(f.properties.date);
                if (dr) {
                    // Use midpoint of date range so it always falls inside one BIN
                    const mid = Math.floor((dr.start + dr.end) / 2);
                    const intervalKey = getDateIntervalForYear(mid);
                    remaining.dates.add(intervalKey);
                }

            });

            return remaining;
        }
        function updateFilterButtonsAvailability(remaining) {
            // --- FONDO BUTTONS ---
            document.querySelectorAll('#fondo-filter .filter-button').forEach(btn => {
                const val = btn.dataset.filterValue;
                if (val === "all" || remaining.fondos.has(val)) {
                    btn.disabled = false;
                    btn.classList.remove("disabled-filter");
                } else {
                    btn.disabled = true;
                    btn.classList.add("disabled-filter");
                }
            });

            // --- TYPE BUTTONS ---
            /*document.querySelectorAll('#type-filter .type-icon').forEach(btn => {
                const val = btn.dataset.filterValue;
                if (val === "all" || remaining.types.has(val)) {
                    btn.disabled = false;
                    btn.classList.remove("disabled-filter");
                } else {
                    btn.disabled = true;
                    btn.classList.add("disabled-filter");
                }
            });*/
            document.querySelectorAll('#type-filter .type-icon').forEach(btn => {
                const val = btn.dataset.type; // note: you use data-type in createIcon()

                if (val === 'all' || remaining.types.has(val)) {
                    btn.classList.remove('disabled-filter');
                    btn.style.pointerEvents = 'auto';
                    btn.style.opacity = '1';
                } else {
                    btn.classList.add('disabled-filter');
                    btn.style.pointerEvents = 'none'; // makes it unclickable
                    btn.style.opacity = '0.5'; // visually gray out
                }
            });


            // --- DATE RANGE BUTTONS ---
            document.querySelectorAll('#date-filter .filter-button').forEach(btn => {
                const val = btn.dataset.filterValue;
                if (val === "all" || remaining.dates.has(val)) {
                    btn.disabled = false;
                    btn.classList.remove("disabled-filter");
                } else {
                    btn.disabled = true;
                    btn.classList.add("disabled-filter");
                }
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/login.js') }}"></script>
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>
    <script src="{{ url_for('static', filename='js/grid.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
{% endblock %}