{% extends "base.html" %}

{% block content %}
<div class="sperimentare-section">
    <div class="section-header">
        <!-- Left big number -->
        <div class="section-number">[3]</div>

        <!-- Right content -->
        <div class="section-text">
            <h2 class="section-title">Sperimentare</h2>
            <p class="section-subtitle">In questa sezione puoi trovare i materiali che hai salvato, organizzarli e cercarne nuovi da aggiungere.</p>
        </div>
    </div>
    <div id="collections-container">

    </div>
    <div class="header-row">
        <div class="create-collection-btn">+</div>
        <span>Crea una nuova raccolta</span>
    </div>
 
    <div class="collections" id="collections"></div>
    <div id="loginModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-icon" onclick="closeLoginModal()">&times;</span>
    
            <div id="login-section" class="section">
                <h3>ARTIFEX</h3>
                <p>Ciao! Per poter salvare i contenuti è necessario autenticarsi</p>
                <img src="{{ url_for('static', filename='img/icons-png/architecture-icon.png') }}">
    
                <input id="login-username" type="text" placeholder="Username" class="input-field">
                <input id="login-password" type="password" placeholder="Password" class="input-field">
    
                <button class="modal-btn" onclick="loginUser()">Accedi</button>
            </div>
        </div>
    </div>
    <div id="new-collection-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-icon" onclick="closeCreationModal()">&times;</span>
            <!-- USER LOGGED IN SECTION -->
            <div id="collection-section" class="section">
                <h4>Crea una nuova racolta</h4>
                <input id="new-collection-name" class="input-field" placeholder="Crea nuova raccolta">
                <button class="modal-btn" onclick="createCollection()">Crea raccolta</button>
            </div>
        </div>
    </div>
</div>
    <script src="login.js"></script>
    <script src="modal.js"></script>
    <script>
    const serverURL = 'http://192.168.249.170:5030'; // replace with your server URL

    // Select the div by its class
    const createBtn = document.querySelector('.create-collection-btn');
    const newCollectionModal = document.getElementById('new-collection-modal');

    // Add a click event listener
    createBtn.addEventListener('click', function() {
        newCollectionModal.classList.remove('hidden');
        // Here you can add your custom JS functionality
    });
    // Function to close modal
    function closeCreationModal() {
        newCollectionModal.classList.add('hidden');
    }
    // -----------------------------
    // LOAD USER COLLECTIONS
    // -----------------------------
    async function loadCollectionsPage() {
        try {
            const res = await fetch(`${serverURL}/user/collections`, {
                credentials: "include" // send session cookie
            });
            const data = await res.json();

            if (!data.success) {
                alert(data.error || "Failed to load collections. Are you logged in?");
                return;
            }

            // Render new collection cards (pretty UI)
            const container = document.getElementById("collections");
            container.innerHTML = "";

            data.collections.forEach(coll => {
                // choose first object’s image or fallback placeholder
                const coverImage = coll.objects.length > 0
                    ? `${serverURL}/images/${coll.objects[0].image}`
                    : "https://via.placeholder.com/400x300?text=Nessuna+Immagine";

                // count objects
                const count = coll.objects.length;

                // Create card
                const card = document.createElement("article");
                card.className = "collection-card";

                card.innerHTML = `
                    <div class="collection-image-wrapper">
                        <img class="collection-image"
                            src="${coverImage}"
                            alt="${coll.name}">
                        <div class="collection-add-btn" data-collection="${coll.name}">+</div>
                    </div>

                    <div class="collection-title">${coll.name.toUpperCase()}</div>
                    <div class="collection-meta">${count.toString().padStart(2, '0')} Elementi</div>`
                    ;
                    
                card.addEventListener("click", () => {
                    window.location.href = `/collection/${encodeURIComponent(coll.name)}`;
                });

                container.appendChild(card);
                const addBtn = card.querySelector('.collection-add-btn');

                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // prevent card click conflicts

                    const collectionName = addBtn.dataset.collection;

                    // Redirect to grid with collection info
                    window.location.href = `/esplorare?addToCollection=${encodeURIComponent(collectionName)}`;
                });

            });
        } catch (err) {
            console.error("Error loading collections:", err);
            alert("Error loading collections. See console for details.");
        }
    }
    // -------------------------
    // SHOW / HIDE LOGIN MODAL
    // -------------------------
    function openLoginModal() {
        document.getElementById("loginModal").classList.remove("hidden");
    }

    function closeLoginModal() {
        document.getElementById("loginModal").classList.add("hidden");
    }

    // -------------------------
    // LOGIN USER
    // -------------------------
    async function loginUser() {
        const username = document.getElementById("login-username").value.trim();
        const password = document.getElementById("login-password").value.trim();

        const res = await fetch(`${serverURL}/login`, {
            method: "POST",
            credentials: "include",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password })
        });

        const data = await res.json();
        if (data.success) {
            closeLoginModal();
            window.location.reload(); // reload page and load collections
        } else {
            alert(data.error || "Login failed");
        }
    }

    // -------------------------
    // CHECK LOGIN STATUS
    // -------------------------
    async function checkLoginStatus() {
        const res = await fetch(`${serverURL}/user/status`, {
            credentials: "include"
        });
        const data = await res.json();

        if (!data.logged_in) {
            openLoginModal();
        } else {
            // user is logged in → load collections
            loadCollectionsPage();
        }
    }
    // RUN ON PAGE LOAD
    window.onload = checkLoginStatus;
    </script>
{% endblock %}
